<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Home AI Controller</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <style>
                :root{
                        --bg1:#071226; --bg2:#0b1a2b;
                        --panel:#0b1220;
                        --text:#e6eef8; --muted:#9fb0c8;
                        --accent:#020b3f;
                        --accent-rgb:2,11,63;
                        --glow: rgba(var(--accent-rgb), .28);
                        --tile-shadow:0 10px 28px rgba(0,0,0,.45);
                }
                html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 100%);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
                .container{max-width:1400px;margin:20px auto;padding:20px}

                .header-top{background:#ffffff;border-radius:12px;padding:12px 18px;margin-bottom:18px;box-shadow:0 10px 30px rgba(2,6,23,0.45);position:relative;width:100%;max-width:1200px;margin-left:auto;margin-right:auto}
                .logos{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
                .logo{flex:1;min-width:120px;text-align:center;border:none;border-radius:10px;padding:10px 12px;background:#fff}
                .logo img{max-height:72px;object-fit:contain;display:inline-block}
                .logo img[src="foundries.png"]{max-height:90px;transform:scale(1.25)}

                .main-content{display:flex;flex-direction:column;gap:20px;margin:20px 0;justify-content:center;align-items:center}

                .audio-panel{width:100%;max-width:1200px}
                .status-wrap{display:flex;flex-direction:column;align-items:center;text-align:center;margin:10px 0 26px}
                .cta{display:inline-flex;align-items:center;gap:12px;padding:12px 18px;border-radius:999px;background:rgba(var(--accent-rgb),0.04);box-shadow:inset 0 0 0 1px rgba(var(--accent-rgb),0.06)}
                .mic{position:relative;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:rgba(var(--accent-rgb),0.08);box-shadow:0 0 0 0 rgba(var(--accent-rgb),0);transition:box-shadow .25s ease, transform .25s ease}
                .mic svg{width:24px;height:24px;opacity:.95;color:var(--accent)}
                .pulse::before,.pulse::after{content:"";position:absolute;inset:0;border-radius:50%;animation:pulse 2.2s ease-out infinite;box-shadow:0 0 0 0 rgba(var(--accent-rgb),.28)}
                .pulse::after{animation-delay:.9s}
                @keyframes pulse{0%{transform:scale(1);opacity:.75}80%,100%{transform:scale(1.8);opacity:0}}

                .status{font-size:44px;font-weight:800;line-height:1.05;margin:14px 0 6px;letter-spacing:.2px;color:var(--text)}
                .chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.25);margin-left:12px;vertical-align:middle}
                .wave{display:flex;gap:4px;height:28px;align-items:center}
                .bar{width:4px;height:100%;background:#7cc7ff;border-radius:2px;opacity:.95;animation:bars 1.2s ease-in-out infinite}
                @keyframes bars{0%{transform:scaleY(0.3);background:#7cc7ff}50%{transform:scaleY(1);background:#ffffff}100%{transform:scaleY(0.3);background:#7cc7ff}}

                .grid-wrap{display:flex;justify-content:center;position:relative}
                .aura{position:absolute;inset:-80px;z-index:0;filter:blur(60px);opacity:.22;pointer-events:none;transition:background .35s ease, opacity .35s ease;background:radial-gradient(600px 300px at 50% 40%, transparent 0%, transparent 50%)}
                .grid{position:relative;z-index:1;display:grid;grid-template-columns:repeat(5,150px);grid-auto-rows:150px;gap:16px;align-items:center;justify-items:center}
                .cell{width:150px;height:150px;border-radius:16px;display:flex;align-items:center;justify-content:center;box-shadow:var(--tile-shadow);border:4px solid rgba(0,0,0,.06);cursor:pointer;user-select:none;transition:transform .18s ease, box-shadow .2s ease, outline-color .18s ease, border-color .18s ease, filter .2s ease;will-change:transform,filter;animation:breath 6s ease-in-out infinite;background-clip:padding-box;position:relative;overflow:visible;}
                .cell::after{content:"";position:absolute;inset:-10px;border-radius:20px;border:3px solid rgba(255,255,255,0.18);opacity:0;box-shadow:0 0 0 0 rgba(var(--accent-rgb),0.0),0 0 0 0 rgba(var(--accent-rgb),0.0);transition:opacity .2s ease;pointer-events:none;}
                .cell::before{content:"";position:absolute;inset:8px;border-radius:12px;opacity:0;transition:opacity .2s ease;pointer-events:none;background:radial-gradient(110px 110px at 35% 30%, rgba(var(--accent-rgb),0.35), rgba(var(--accent-rgb),0.10) 55%, rgba(var(--accent-rgb),0.0) 75%);mix-blend-mode:screen;}
                @keyframes breath{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
                .cell:active{transform:scale(.98)}
                .label{font-weight:800;letter-spacing:.4px;text-transform:capitalize;font-size:18px;color:#06131d}
                .blue{background:#1e90ff;--accent-rgb:30,144,255}
                .green{background:#2dd4bf;--accent-rgb:45,212,191}
                .purple{background:#9b7bff;--accent-rgb:155,123,255}
                .red{background:#ff5c6c;--accent-rgb:255,92,108}
                .yellow{background:#ffd166;--accent-rgb:255,209,102}
                .selected{
                    transform:none!important;
                    outline:none;
                    box-shadow:0 24px 50px rgba(0,0,0,.55);
                    filter:saturate(1.35) brightness(1.18);
                    z-index:6;
                    animation:none;
                    will-change:box-shadow;
                    backface-visibility:hidden;
                    transform:translateZ(0);
                    outline-offset:0;
                    border-color:rgba(255,255,255,.25);
                    background-clip:padding-box;
                    pointer-events:auto;
                    isolation:isolate;
                }
                .selected::before{
                    opacity:1;
                    background:radial-gradient(120px 120px at 35% 30%, rgba(var(--accent-rgb),0.65), rgba(var(--accent-rgb),0.28) 55%, rgba(var(--accent-rgb),0.0) 75%);
                }
                .selected::after{
                    opacity:1;
                    border-color:rgba(var(--accent-rgb),.95);
                    box-shadow:
                        0 0 0 4px rgba(var(--accent-rgb),.75),
                        0 0 32px rgba(var(--accent-rgb),.90),
                        0 0 90px rgba(var(--accent-rgb),.95),
                        inset 0 0 22px rgba(var(--accent-rgb),.55);
                }

                .header-bottom{background:#ffffff;border-radius:12px;padding:14px 18px;margin-top:18px;box-shadow:0 10px 30px rgba(2,6,23,0.45);color:var(--accent);display:flex;justify-content:center;align-items:center;flex-direction:column;width:100%;max-width:1200px;margin-left:auto;margin-right:auto}
                .header-bottom .tips{margin:0;font-weight:600;color:#020b3f;font-size:18px}

                @media (max-width:920px){.grid{grid-template-columns:repeat(3,150px)}.status{font-size:36px}}
                @media (max-width:700px){.grid{grid-template-columns:repeat(2,140px);grid-auto-rows:140px}.cell{width:140px;height:140px}.status{font-size:30px}}
                @media (max-width:420px){.grid{grid-template-columns:repeat(2,120px);grid-auto-rows:120px}.cell{width:120px;height:120px}.status{font-size:24px}}
        </style>
</head>
<body>
    <div class="container">
        <div class="header-top">
            <div class="logos" aria-hidden="true">
                <div class="logo"><img src="/assets/arduino.png" alt="Arduino" onerror="this.style.opacity=.5;this.style.filter='grayscale(70%)'"/></div>
                <div class="logo"><img src="/assets/edgeimpulse.png" alt="Edge Impulse" onerror="this.style.opacity=.5;this.style.filter='grayscale(70%)'"/></div>
                <div class="logo"><img src="/assets/foundries.png" alt="Foundries.io" onerror="this.style.opacity=.5;this.style.filter='grayscale(70%)'"/></div>
                <div class="logo"><img src="/assets/qualcomm.png" alt="Qualcomm" onerror="this.style.opacity=.5;this.style.filter='grayscale(70%)'"/></div>
            </div>
        </div>

        <div class="main-content">
            <div class="audio-panel">
                <div class="status-wrap" role="status" aria-live="polite">
                    <div class="cta">
                        <div id="mic" class="mic" title="Click a color">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2Zm-5 7a7.002 7.002 0 0 1-6.32-4H4a9 9 0 0 0 8 5v3h2v-3a9 9 0 0 0 8-5h-1.68A7.002 7.002 0 0 1 12 18Z"/></svg>
                        </div>
                        <div>
                            <div id="status" class="status">
                                <span id="chipLeft" class="chip" style="display:none;margin-right:12px;margin-left:0">
                                    <div class="wave" aria-hidden="true">
                                        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                                    </div>
                                </span>
                                <span id="statusText">Click a color to start</span>
                                <span id="chip" class="chip" style="display:none">
                                    <div class="wave" aria-hidden="true">
                                        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                                    </div>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid-wrap">
                    <div id="aura" class="aura"></div>
                    <div id="colorGrid" class="grid" role="list">
                        <button class="cell blue" data-color="blue" role="listitem" aria-label="Blue"><span class="label">Blue</span></button>
                        <button class="cell green" data-color="green" role="listitem" aria-label="Green"><span class="label">Green</span></button>
                        <button class="cell purple" data-color="purple" role="listitem" aria-label="Purple"><span class="label">Purple</span></button>
                        <button class="cell red" data-color="red" role="listitem" aria-label="Red"><span class="label">Red</span></button>
                        <button class="cell yellow" data-color="yellow" role="listitem" aria-label="Yellow"><span class="label">Yellow</span></button>
                    </div>
                </div>
            </div>

            <div class="header-bottom">
                <div class="tips" id="tips">Click any color tile.</div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const statusTextEl = document.getElementById('statusText');
            const chipEl = document.getElementById('chip');
            const chipLeftEl = document.getElementById('chipLeft');
            const micEl = document.getElementById('mic');
            const auraEl = document.getElementById('aura');
            const tipsEl = document.getElementById('tips');
            const cells = Array.from(document.querySelectorAll('.cell'));
            let selectedCell = null;
            let currentSelectedColor = '';

            const COLORS = {
                blue:'#1e90ff', green:'#2dd4bf', purple:'#9b7bff',
                red:'#ff5c6c', yellow:'#ffd166'
            };

            function setListeningUI(isListening){
                chipEl.style.display = isListening ? 'inline-flex' : 'none';
                chipLeftEl.style.display = isListening ? 'inline-flex' : 'none';
                micEl.classList.toggle('pulse', isListening);
                micEl.style.transform = isListening ? 'scale(1.06)' : 'scale(1)';
            }

            function clearSelection(){
                if(selectedCell){
                    selectedCell.classList.remove('selected');
                    selectedCell.removeAttribute('aria-pressed');
                    selectedCell = null;
                }
                currentSelectedColor = '';
            }

            function highlightColor(color){
                if(!color){
                    clearSelection();
                    return;
                }
                if (currentSelectedColor === color && selectedCell) {
                    return;
                }
                clearSelection();
                const el = document.querySelector(`.cell[data-color="${color}"]`);
                if(!el) return;
                el.classList.add('selected');
                el.setAttribute('aria-pressed','true');
                try{ el.focus({preventScroll:true}); }catch(e){}
                selectedCell = el;
                currentSelectedColor = color;
                const c = COLORS[color] || '#7cc7ff';
                auraEl.style.background = `radial-gradient(520px 280px at 50% 40%, ${c}33 0%, transparent 55%)`;
                auraEl.style.opacity = '.35';
                setTimeout(()=> auraEl.style.opacity = '.22', 600);
            }

            async function sendColor(color){
                try{
                    await fetch('/api/color', {
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({color})
                    });
                }catch(e){}
            }

            cells.forEach(c=>{
                c.addEventListener('click', async ()=>{
                    const color = c.getAttribute('data-color');
                    if (currentSelectedColor === color) {
                        clearSelection();
                        statusTextEl.textContent = 'Off';
                        await sendColor('off');
                        return;
                    }
                    highlightColor(color);
                    statusTextEl.textContent = `Color: ${color}`;
                    await sendColor(color);
                });
            });

            const idleTips = [
                'Click any color tile.',
                'Choose a color to set the LED.',
                'Tap Blue, Green, Red, Purple, or Yellow.'
            ];
            let tipIdx = 0;
            setInterval(()=>{ tipIdx=(tipIdx+1)%idleTips.length; tipsEl.textContent = idleTips[tipIdx]; }, 4200);

            function reflectStatus(s){
                if(!s) return;
                statusTextEl.textContent = s;
                setListeningUI(false);
            }

            const es = new EventSource('/status');
            es.onmessage = (evt) => {
                try {
                    const data = JSON.parse(evt.data);
                    reflectStatus(data.status || '');
                    if (data.color === '') { clearSelection(); return; }
                    if (data.color) { highlightColor(data.color); }
                } catch(e){}
            };
        })();
    </script>
</body>
</html>

